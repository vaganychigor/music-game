<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Музыкальная Игра</title>
  <style>
    body {
      font-family: sans-serif;
    }

    #roleSelect {
      position: fixed;
      top: 20px;
      left: 20px;
      background: white;
      padding: 10px;
      z-index: 999;
    }

    .player-block {
      margin-bottom: 20px;
      border: 1px solid #ccc;
      padding: 10px;
    }

    .player-block button {
      margin: 5px;
    }

    #scoreDisplay {
      position: fixed;
      bottom: 0;
      left: 0;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      width: 100%;
      text-align: center;
      font-size: 18px;
      z-index: 1000;
    }

    .highlight {
      background-color: #e0f7fa;
    }

    #playerNameInput {
      margin: 10px 0;
    }

    #clientView {
      padding: 40px;
      font-size: 24px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="roleSelect">
    <button id="hostBtn">Я — Хост</button>
    <button id="clientBtn">Я — Игрок</button>
  </div>

  <div id="hostView" style="display:none;">
    <h1>Музыкальная Игра</h1>

    <div>
      <label>Имя игрока: <input id="playerNameInput" type="text" /></label>
      <button onclick="sendName()">Сохранить</button>
    </div>

    <div id="playersContainer"></div>
  </div>

  <div id="clientView" style="display:none;">
    <div id="clientName">Имя: Игрок</div>
    <div id="clientScore">Очки: 0</div>
  </div>

  <audio id="player" controls style="display:none;"></audio>

  <div id="scoreDisplay">
    <strong>Очки игрока:</strong> <span id="score">0</span>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let isHost = false;
    let score = 0;
    let playerName = 'Игрок';
    const scoreEl = document.getElementById('score');
    const playerNameInput = document.getElementById('playerNameInput');

    function updateScore(amount) {
      score += amount;
      scoreEl.textContent = score;
      socket.emit('scoreUpdate', score);
    }

    function setScore(newScore) {
      score = newScore;
      scoreEl.textContent = score;
    }

    function playTrack(filename) {
      if (!isHost) return;
      socket.emit('playTrack', filename);
      playAudio(filename);
    }

    function playAudio(file) {
      const player = document.getElementById('player');
      player.src = file;
      player.play();
    }

    function sendName() {
      playerName = playerNameInput.value || 'Игрок';
      socket.emit('nameUpdate', playerName);
    }

    // Socket events
    socket.on('playTrack', file => {
      if (!isHost) playAudio(file);
    });

    socket.on('scoreUpdate', newScore => {
      if (!isHost) {
        document.getElementById('clientScore').textContent = `Очки: ${newScore}`;
      }
    });

    socket.on('nameUpdate', name => {
      if (!isHost) {
        document.getElementById('clientName').textContent = `Имя: ${name}`;
      }
    });

    // Role selection
    document.getElementById('hostBtn').onclick = () => {
      isHost = true;
      document.getElementById('roleSelect').style.display = 'none';
      document.getElementById('hostView').style.display = 'block';
    };

    document.getElementById('clientBtn').onclick = () => {
      isHost = false;
      document.getElementById('roleSelect').style.display = 'none';
      document.getElementById('clientView').style.display = 'block';
      document.getElementById('scoreDisplay').style.display = 'none';
    };

    // Host interface generation
    const playersContainer = document.getElementById('playersContainer');

    for (let round = 1; round <= 17; round++) {
      const block = document.createElement('div');
      block.className = 'player-block';
      block.innerHTML = `<h3>Раунд ${round}</h3>`;

      const tracks = [
        [`${round}_1_10.wav`, 'Песня №1, 10 секунд'],
        [`${round}_1_20.wav`, 'Песня №1, 20 секунд'],
        [`${round}_2_10.wav`, 'Песня №2, 10 секунд'],
        [`${round}_2_20.wav`, 'Песня №2, 20 секунд']
      ];

      if (round === 8) {
        tracks.push([`${round}_3_10.wav`, 'Песня №3, 10 секунд']);
        tracks.push([`${round}_3_20.wav`, 'Песня №3, 20 секунд']);
      }

      tracks.forEach(([filename, label], idx) => {
        const btn = document.createElement('button');
        btn.textContent = `▶ ${label}`;
        if (idx % 2 === 1) btn.classList.add('highlight');
        btn.onclick = () => playTrack(filename);
        block.appendChild(btn);
      });

      const controls = document.createElement('div');
      controls.innerHTML = `
        <button onclick="updateScore(1000)">+1000</button>
        <button onclick="updateScore(-500)">-500</button>
        <button onclick="updateScore(-1000)">-1000</button>
      `;
      block.appendChild(controls);

      playersContainer.appendChild(block);
    }
  </script>
</body>
</html>
